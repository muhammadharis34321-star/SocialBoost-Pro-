<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - SocialBoost Pro</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="https://cdn-icons-png.flaticon.com/512/3133/3133301.png"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #6a11cb;
        --secondary: #2575fc;
        --success: #00c851;
        --warning: #ffbb33;
        --danger: #ff4444;
        --dark: #1a1a2e;
        --light: #f8f9fa;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background: #f5f7fa;
        color: var(--dark);
        padding: 20px;
      }

      .admin-container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .admin-header {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        text-align: center;
      }

      .admin-header h1 {
        color: var(--primary);
        margin-bottom: 10px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      .stat-card h3 {
        font-size: 2rem;
        color: var(--primary);
        margin-bottom: 10px;
      }

      .orders-table {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      th {
        background: var(--primary);
        color: white;
        font-weight: 600;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }
      .status-paid {
        background: #d1ecf1;
        color: #0c5460;
      }
      .status-processing {
        background: #d1ecf1;
        color: #0c5460;
      }
      .status-completed {
        background: #d4edda;
        color: #155724;
      }
      .status-cancelled {
        background: #f8d7da;
        color: #721c24;
      }

      .btn {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 2px;
        font-size: 12px;
      }

      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-warning {
        background: var(--warning);
        color: black;
      }
      .btn-danger {
        background: var(--danger);
        color: white;
      }
      .btn-info {
        background: var(--primary);
        color: white;
      }
      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        opacity: 0.9;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 15px;
        width: 80%;
        max-width: 600px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: var(--danger);
      }

      .order-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
      }

      .detail-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid var(--primary);
      }

      .detail-item strong {
        color: var(--primary);
        display: block;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <h1><i class="fas fa-cog"></i> Admin Panel - SocialBoost Pro</h1>
        <p>Manage all customer orders and track payments</p>
      </div>

      <div class="stats-grid" id="statsContainer">
        <!-- Stats will be loaded here -->
      </div>

      <div class="orders-table">
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Platform</th>
              <th>Service</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Payment</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTable">
            <!-- Orders will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitle">Order Details</h2>
        <div id="orderDetailsContent">
          <!-- Order details will be loaded here -->
        </div>
      </div>
    </div>

    <script>

      // ✅ BACKEND API CONFIGURATION
const API_BASE = 'https://python22.pythonanywhere.com';

// ✅ TEST BACKEND CONNECTION
async function testBackend() {
    try {
        const response = await fetch(`${API_BASE}/test`);
        const data = await response.json();
        console.log('✅ Backend connected:', data);
    } catch (error) {
        console.error('❌ Backend connection failed:', error);
    }
}
      // Load admin data
      async function loadAdminData() {
        try {
          // Load stats
          const statsResponse = await fetch("/admin/stats");
          const statsData = await statsResponse.json();

          if (statsData.success) {
            displayStats(statsData.stats);
          }

          // Load orders
          const ordersResponse = await fetch("/admin/orders");
          const ordersData = await ordersResponse.json();

          if (ordersData.success) {
            displayOrders(ordersData.orders);
          }
        } catch (error) {
          console.error("Error loading admin data:", error);
        }
      }

      function displayStats(stats) {
        const statsContainer = document.getElementById("statsContainer");
        statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>${stats.total_orders}</h3>
                    <p>Total Orders</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.paid_orders}</h3>
                    <p>Paid Orders</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.completed_orders}</h3>
                    <p>Completed</p>
                </div>
                <div class="stat-card">
                    <h3>Rs. ${stats.total_revenue}</h3>
                    <p>Total Revenue</p>
                </div>
            `;
      }

      function displayOrders(orders) {
        const ordersTable = document.getElementById("ordersTable");

        if (orders.length === 0) {
          ordersTable.innerHTML =
            '<tr><td colspan="9" style="text-align: center;">No orders found</td></tr>';
          return;
        }

        ordersTable.innerHTML = orders
          .map(
            (order) => `
                <tr>
                    <td><strong>${order.order_id}</strong></td>
                    <td>
                        <div>${order.username}</div>
                        <small>${order.email}</small><br>
                        <small>${order.phone}</small>
                    </td>
                    <td>${order.platform}</td>
                    <td>${order.service_type} (${order.quantity})</td>
                    <td>Rs. ${order.total_amount}</td>
                    <td>
                        <span class="status-badge status-${order.status}">
                            ${order.status}
                        </span>
                    </td>
                    <td>${order.payment_method}</td>
                    <td>${new Date(order.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-info" onclick="viewOrderDetails('${
                          order.order_id
                        }')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success" onclick="updateOrderStatus('${
                          order.order_id
                        }', 'completed')" title="Mark Completed">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-warning" onclick="updateOrderStatus('${
                          order.order_id
                        }', 'processing')" title="Mark Processing">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteOrder('${
                          order.order_id
                        }')" title="Delete Order">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function updateOrderStatus(orderId, newStatus) {
        if (!confirm(`Change order ${orderId} to ${newStatus}?`)) {
          return;
        }

        try {
          const response = await fetch("/admin/update-status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              order_id: orderId,
              status: newStatus,
            }),
          });

          const data = await response.json();

          if (data.success) {
            alert("Order status updated successfully!");
            loadAdminData();
          } else {
            alert("Error: " + data.error);
          }
        } catch (error) {
          alert("Network error. Please try again.");
        }
      }

      //  DELETE ORDER FUNCTION
      async function deleteOrder(orderId) {
        if (
          !confirm(
            `Are you sure you want to DELETE order ${orderId}? This action cannot be undone!`
          )
        ) {
          return;
        }

        try {
          const response = await fetch("/admin/delete-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              order_id: orderId,
            }),
          });

          const data = await response.json();

          if (data.success) {
            alert("Order deleted successfully!");
            loadAdminData();
          } else {
            alert("Error: " + data.error);
          }
        } catch (error) {
          alert("Network error. Please try again.");
        }
      }

      // VIEW ORDER DETAILS FUNCTION
      async function viewOrderDetails(orderId) {
        try {
          const response = await fetch(`/admin/order-details/${orderId}`);
          const data = await response.json();

          if (data.success) {
            displayOrderDetails(data.order);
          } else {
            alert("Error: " + data.error);
          }
        } catch (error) {
          alert("Network error. Please try again.");
        }
      }

      function displayOrderDetails(order) {
        const modal = document.getElementById("orderModal");
        const modalTitle = document.getElementById("modalTitle");
        const content = document.getElementById("orderDetailsContent");

        modalTitle.textContent = `Order Details - ${order.order_id}`;

        content.innerHTML = `
                <div class="order-details-grid">
                    <div class="detail-item">
                        <strong>Customer Information</strong>
                        <div>Username: ${order.username}</div>
                        <div>Email: ${order.email}</div>
                        <div>Phone: ${order.phone}</div>
                    </div>
                    
                    <div class="detail-item">
                        <strong>Order Information</strong>
                        <div>Platform: ${order.platform}</div>
                        <div>Service: ${order.service_type}</div>
                        <div>Quantity: ${order.quantity}</div>
                        <div>Amount: Rs. ${order.total_amount}</div>
                    </div>
                    
                    <div class="detail-item">
                        <strong>Payment Information</strong>
                        <div>Method: ${order.payment_method}</div>
                        <div>Status: ${order.status}</div>
                        <div>Transaction ID: ${
                          order.transaction_id || "N/A"
                        }</div>
                        <div>Payment Verified: ${
                          order.payment_verified_at || "Not verified"
                        }</div>
                    </div>
                    
                    <div class="detail-item">
                        <strong>Timestamps</strong>
                        <div>Created: ${new Date(
                          order.created_at
                        ).toLocaleString()}</div>
                        <div>Updated: ${
                          order.updated_at
                            ? new Date(order.updated_at).toLocaleString()
                            : "N/A"
                        }</div>
                        <div>Completed: ${
                          order.completed_at
                            ? new Date(order.completed_at).toLocaleString()
                            : "N/A"
                        }</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-danger" onclick="deleteOrder('${
                      order.order_id
                    }')">
                        <i class="fas fa-trash"></i> Delete This Order
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal()" style="margin-left: 10px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;

        modal.style.display = "block";
      }

      // Modal close functionality
      function closeModal() {
        document.getElementById("orderModal").style.display = "none";
      }

      // Close modal when clicking on X
      document.querySelector(".close").addEventListener("click", closeModal);

      // Close modal when clicking outside
      window.addEventListener("click", function (event) {
        const modal = document.getElementById("orderModal");
        if (event.target === modal) {
          closeModal();
        }
      });

      // Load data when page loads
      document.addEventListener("DOMContentLoaded", loadAdminData);

      // Auto-refresh every 30 seconds
      setInterval(loadAdminData, 30000);
    </script>
  </body>
</html>
