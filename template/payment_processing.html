<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Processing - SocialBoost Pro</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="https://cdn-icons-png.flaticon.com/512/3133/3133301.png"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #6a11cb;
        --secondary: #2575fc;
        --success: #00c851;
        --warning: #ffbb33;
        --info: #33b5e5;
        --dark: #1a1a2e;
        --light: #f8f9fa;
        --border-radius: 15px;
        --box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #333;
        line-height: 1.6;
      }

      .processing-container {
        background: white;
        max-width: 600px;
        width: 100%;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: var(--box-shadow);
        text-align: center;
      }

      .processing-header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 40px 30px;
        position: relative;
      }

      .processing-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #ffd700, #ffed4e, #ffd700);
      }

      .processing-header h1 {
        font-size: 32px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      .processing-header p {
        opacity: 0.9;
        font-size: 16px;
      }

      .processing-body {
        padding: 40px 30px;
      }

      .spinner-container {
        position: relative;
        margin: 30px auto;
        width: 100px;
        height: 100px;
      }

      .spinner {
        border: 6px solid #f3f3f3;
        border-top: 6px solid var(--primary);
        border-radius: 50%;
        width: 80px;
        height: 80px;
        animation: spin 1.5s linear infinite;
        position: absolute;
        top: 10px;
        left: 10px;
      }

      .spinner-inner {
        border: 4px solid transparent;
        border-top: 4px solid var(--secondary);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite reverse;
        position: absolute;
        top: 20px;
        left: 20px;
      }

      .checkmark {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: block;
        stroke-width: 4;
        stroke: #fff;
        stroke-miterlimit: 10;
        margin: 20px auto;
        box-shadow: inset 0px 0px 0px var(--success);
        animation: fill 0.4s ease-in-out 0.4s forwards,
          scale 0.3s ease-in-out 0.9s both;
      }

      .checkmark__circle {
        stroke-dasharray: 166;
        stroke-dashoffset: 166;
        stroke-width: 4;
        stroke-miterlimit: 10;
        stroke: var(--success);
        fill: none;
        animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
      }

      .checkmark__check {
        transform-origin: 50% 50%;
        stroke-dasharray: 48;
        stroke-dashoffset: 48;
        animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes stroke {
        100% {
          stroke-dashoffset: 0;
        }
      }

      @keyframes scale {
        0%,
        100% {
          transform: none;
        }
        50% {
          transform: scale3d(1.1, 1.1, 1);
        }
      }

      @keyframes fill {
        100% {
          box-shadow: inset 0px 0px 0px 60px var(--success);
        }
      }

      .progress-container {
        background: #f8f9fa;
        border-radius: var(--border-radius);
        padding: 25px;
        margin: 25px 0;
      }

      .progress-steps {
        display: flex;
        justify-content: space-between;
        position: relative;
        margin-bottom: 30px;
      }

      .progress-steps::before {
        content: "";
        position: absolute;
        top: 15px;
        left: 0;
        right: 0;
        height: 4px;
        background: #e9ecef;
        z-index: 1;
      }

      .progress-bar {
        position: absolute;
        top: 15px;
        left: 0;
        height: 4px;
        background: var(--primary);
        z-index: 2;
        transition: var(--transition);
        width: 0%;
      }

      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 3;
        position: relative;
      }

      .step-icon {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        transition: var(--transition);
      }

      .step.active .step-icon {
        background: var(--primary);
        color: white;
      }

      .step.completed .step-icon {
        background: var(--success);
        color: white;
      }

      .step-text {
        font-size: 12px;
        font-weight: 600;
        color: #6c757d;
        text-align: center;
      }

      .step.active .step-text {
        color: var(--primary);
      }

      .step.completed .step-text {
        color: var(--success);
      }

      .order-details {
        background: #f8f9fa;
        border-radius: var(--border-radius);
        padding: 25px;
        margin: 25px 0;
        text-align: left;
      }

      .order-details h3 {
        margin-bottom: 15px;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .detail-item {
        padding: 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .detail-item strong {
        color: var(--primary);
        display: block;
        margin-bottom: 5px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-message {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        padding: 20px;
        border-radius: var(--border-radius);
        margin: 20px 0;
        text-align: center;
      }

      .status-message p {
        margin-bottom: 10px;
        font-weight: 500;
      }

      .timer {
        font-size: 14px;
        color: #6c757d;
        margin-top: 10px;
      }

      .support-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: var(--border-radius);
        text-align: center;
        margin-top: 25px;
        border-top: 1px solid #e9ecef;
      }

      .support-section p {
        color: #6c757d;
        margin-bottom: 10px;
      }

      .support-link {
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .support-link:hover {
        text-decoration: underline;
      }

      .hidden {
        display: none;
      }

      .btn {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(106, 17, 203, 0.3);
      }

      @media (max-width: 768px) {
        .processing-body {
          padding: 30px 20px;
        }

        .processing-header {
          padding: 30px 20px;
        }

        .processing-header h1 {
          font-size: 24px;
        }

        .detail-grid {
          grid-template-columns: 1fr;
        }

        .progress-steps {
          flex-direction: column;
          gap: 20px;
          align-items: flex-start;
        }

        .progress-steps::before {
          display: none;
        }

        .progress-bar {
          display: none;
        }

        .step {
          flex-direction: row;
          gap: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="processing-container">
      <div class="processing-header">
        <h1><i class="fas fa-sync-alt"></i> Payment Processing</h1>
        <p>Please wait while we verify your payment</p>
      </div>

      <div class="processing-body">
        <!-- Processing State -->
        <div id="processingState">
          <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-inner"></div>
          </div>

          <h2>Verifying Your Payment</h2>
          <p>We are currently processing your {{ method }} payment...</p>

          <div class="progress-container">
            <div class="progress-steps">
              <div class="progress-bar" id="progressBar"></div>
              <div class="step active" id="step1">
                <div class="step-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                <div class="step-text">Payment Sent</div>
              </div>
              <div class="step" id="step2">
                <div class="step-icon">
                  <i class="fas fa-search"></i>
                </div>
                <div class="step-text">Verifying</div>
              </div>
              <div class="step" id="step3">
                <div class="step-icon">
                  <i class="fas fa-check"></i>
                </div>
                <div class="step-text">Confirmed</div>
              </div>
            </div>
          </div>

          <div class="order-details">
            <h3><i class="fas fa-receipt"></i> Order Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <strong>Order ID</strong>
                <span id="displayOrderId">{{ order.order_id }}</span>
              </div>
              <div class="detail-item">
                <strong>Amount</strong>
                <span id="displayAmount">{{ order.total_amount }} PKR</span>
              </div>
              <div class="detail-item">
                <strong>Platform</strong>
                <span id="displayPlatform">{{ order.platform }}</span>
              </div>
              <div class="detail-item">
                <strong>Service</strong>
                <span id="displayService">{{ order.service_type }}</span>
              </div>
              <div class="detail-item">
                <strong>Quantity</strong>
                <span id="displayQuantity">{{ order.quantity }}</span>
              </div>
              <div class="detail-item">
                <strong>Payment Method</strong>
                <span id="displayMethod">{{ method|title }}</span>
              </div>
            </div>
          </div>

          <div class="status-message">
            <p>
              <i class="fas fa-info-circle"></i> This process usually takes 1-2
              minutes
            </p>
            <div class="timer" id="timer">Time elapsed: 0 seconds</div>
          </div>
        </div>

        <!-- Success State -->
        <div id="successState" class="hidden">
          <svg
            class="checkmark"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 52 52"
          >
            <circle
              class="checkmark__circle"
              cx="26"
              cy="26"
              r="25"
              fill="none"
            />
            <path
              class="checkmark__check"
              fill="none"
              d="M14.1 27.2l7.1 7.2 16.7-16.8"
            />
          </svg>

          <h2>Payment Verified Successfully! ðŸŽ‰</h2>
          <p>
            Your payment has been confirmed and your order is now being
            processed.
          </p>

          <div class="order-details">
            <h3><i class="fas fa-check-circle"></i> Payment Confirmed</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <strong>Order ID</strong>
                <span id="successOrderId">{{ order.order_id }}</span>
              </div>
              <div class="detail-item">
                <strong>Amount Paid</strong>
                <span id="successAmount">{{ order.total_amount }} PKR</span>
              </div>
              <div class="detail-item">
                <strong>Transaction ID</strong>
                <span id="transactionId">Loading...</span>
              </div>
              <div class="detail-item">
                <strong>Status</strong>
                <span style="color: var(--success); font-weight: 600"
                  >Confirmed</span
                >
              </div>
            </div>
          </div>

          <div
            class="status-message"
            style="background: #d4edda; border-color: #c3e6cb"
          >
            <p>
              <i class="fas fa-rocket"></i> Your order has been queued for
              processing!
            </p>
            <p>You will receive updates on your registered email.</p>
          </div>

          <button class="btn" onclick="redirectToSuccess()">
            <i class="fas fa-external-link-alt"></i> View Order Status
          </button>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden">
          <div style="font-size: 80px; color: var(--warning); margin: 20px 0">
            <i class="fas fa-exclamation-triangle"></i>
          </div>

          <h2>Payment Verification Failed</h2>
          <p id="errorMessage">There was an issue verifying your payment.</p>

          <div
            class="status-message"
            style="background: #ffeaa7; border-color: #ffeaa7"
          >
            <p>
              <i class="fas fa-info-circle"></i> Please check your payment
              details and try again.
            </p>
          </div>

          <button
            class="btn"
            onclick="retryVerification()"
            style="background: var(--warning)"
          >
            <i class="fas fa-redo"></i> Try Again
          </button>

          <button
            class="btn"
            onclick="contactSupport()"
            style="background: var(--dark); margin-left: 10px"
          >
            <i class="fas fa-headset"></i> Contact Support
          </button>
        </div>

        <div class="support-section">
          <p>Need help with your payment?</p>
          <a href="mailto:support@socialboostpro.com" class="support-link">
            <i class="fas fa-envelope"></i> support@socialboostpro.com
          </a>
        </div>
      </div>
    </div>
    <script>
      // âœ… BACKEND API CONFIGURATION
const API_BASE = 'https://python22.pythonanywhere.com';

// âœ… TEST BACKEND CONNECTION
async function testBackend() {
    try {
        const response = await fetch(`${API_BASE}/test`);
        
        // Pehle text mein receive karo
        const text = await response.text();
        console.log('âœ… Backend connected:', text);
        
        // Phir JSON try karo
        try {
            const data = JSON.parse(text);
            console.log('âœ… Backend JSON:', data);
        } catch {
            console.log('âœ… Backend Text:', text);
        }
        
    } catch (error) {
        console.error('âŒ Backend connection failed:', error);
    }
}

// Page load pe test karo
window.addEventListener('load', testBackend);

   
      // Debugging - Check karte hain kahan error aa raha hai
      console.log("=== PAYMENT PROCESSING DEBUG ===");

      try {
        // Get order data from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get("order_id") || "{{ order.order_id }}";
        const paymentMethod = urlParams.get("method") || "{{ method }}";

        console.log("URL Params:", {
          order_id: urlParams.get("order_id"),
          method: urlParams.get("method"),
        });

        console.log("Template Variables:", {
          order_id: "{{ order.order_id }}",
          method: "{{ method }}",
          phone: "{{ order.phone }}",
          amount: "{{ order.total_amount }}",
        });

        // Check if required variables are available
        if (!orderId) {
          console.error("ERROR: Order ID is missing");
          showErrorState("Order ID not found. Please try again.");
          return;
        }

        if (!paymentMethod) {
          console.error("ERROR: Payment method is missing");
          showErrorState("Payment method not specified.");
          return;
        }

        let timerSeconds = 0;
        let progressInterval;
        let verificationAttempts = 0;
        const maxAttempts = 3;

        // DOM elements - add null checks
        const timerElement = document.getElementById("timer");
        const progressBar = document.getElementById("progressBar");
        const step1 = document.getElementById("step1");
        const step2 = document.getElementById("step2");
        const step3 = document.getElementById("step3");

        console.log("DOM Elements:", {
          timerElement: !!timerElement,
          progressBar: !!progressBar,
          step1: !!step1,
          step2: !!step2,
          step3: !!step3,
        });

        // Start timer only if element exists
        let timerInterval;
        if (timerElement) {
          timerInterval = setInterval(() => {
            timerSeconds++;
            timerElement.textContent = `Time elapsed: ${timerSeconds} seconds`;
          }, 1000);
        } else {
          console.error("Timer element not found");
        }

        function updateProgress(percent) {
          console.log(`Updating progress: ${percent}%`);
          if (progressBar) {
            progressBar.style.width = percent + "%";
          } else {
            console.error("Progress bar element not found");
          }

          // Add null checks for step elements
          if (percent >= 33 && step1 && step2) {
            step1.classList.add("completed");
            step2.classList.add("active");
          }
          if (percent >= 66 && step2 && step3) {
            step2.classList.add("completed");
            step3.classList.add("active");
          }
          if (percent >= 100 && step3) {
            step3.classList.add("completed");
          }
        }

        // Simulate processing
        let progress = 0;
        if (progressBar) {
          progressInterval = setInterval(() => {
            progress += 1;
            updateProgress(progress);

            if (progress >= 100) {
              clearInterval(progressInterval);
              verifyPayment();
            }
          }, 100);
        } else {
          console.error(
            "Progress bar not found, starting verification directly"
          );
          setTimeout(verifyPayment, 2000);
        }

        // FIXED PAYMENT VERIFICATION FUNCTION
        async function verifyPayment() {
          try {
            verificationAttempts++;

            console.log(
              `Verification attempt ${verificationAttempts} of ${maxAttempts}`
            );

            const requestData = {
              order_id: orderId,
              payment_method: paymentMethod,
              phone_number: "{{ order.phone }}" || "N/A",
              amount: parseInt("{{ order.total_amount }}" || "0"),
            };

            console.log("Sending payment verification request:", requestData);

            const response = await fetch("/api/verify-payment", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(requestData),
            });

            console.log("Response status:", response.status);

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Response data:", data);

            if (data.success) {
              // Success
              console.log("Payment verified successfully");
              if (timerInterval) clearInterval(timerInterval);
              showSuccessState(data.transaction_id);
            } else {
              // Error
              console.log("Payment verification failed:", data.message);
              if (verificationAttempts < maxAttempts) {
                console.log(
                  `Retrying... Attempt ${
                    verificationAttempts + 1
                  } of ${maxAttempts}`
                );
                setTimeout(verifyPayment, 2000);
              } else {
                showErrorState(
                  data.message ||
                    "Payment verification failed after multiple attempts"
                );
              }
            }
          } catch (error) {
            console.error("Payment verification error:", error);

            if (verificationAttempts < maxAttempts) {
              console.log(
                `Retrying after error... Attempt ${
                  verificationAttempts + 1
                } of ${maxAttempts}`
              );
              setTimeout(verifyPayment, 2000);
            } else {
              showErrorState(
                "Network error. Please check your connection and try again."
              );
            }
          }
        }

        function showSuccessState(transactionId) {
          console.log("Showing success state");
          const processingState = document.getElementById("processingState");
          const successState = document.getElementById("successState");

          if (processingState) processingState.classList.add("hidden");
          if (successState) {
            successState.classList.remove("hidden");
            const transactionIdElement =
              document.getElementById("transactionId");
            if (transactionIdElement) {
              transactionIdElement.textContent =
                transactionId || `AUTO_${orderId}`;
            }
          }

          // Auto redirect after 5 seconds
          setTimeout(() => {
            redirectToSuccess(transactionId);
          }, 5000);
        }

        function showErrorState(message) {
          console.log("Showing error state:", message);
          const processingState = document.getElementById("processingState");
          const errorState = document.getElementById("errorState");

          if (processingState) processingState.classList.add("hidden");
          if (errorState) {
            errorState.classList.remove("hidden");
            const errorMessageElement = document.getElementById("errorMessage");
            if (errorMessageElement) {
              errorMessageElement.textContent = message;
            }
          }

          if (timerInterval) clearInterval(timerInterval);
          if (progressInterval) clearInterval(progressInterval);
        }

        function redirectToSuccess(transactionId) {
          const finalTransactionId = transactionId || `AUTO_${orderId}`;
          console.log("Redirecting to success page");
          window.location.href = `/payment-success?order_id=${orderId}&transaction_id=${finalTransactionId}`;
        }

        function retryVerification() {
          console.log("Retrying verification");
          const errorState = document.getElementById("errorState");
          const processingState = document.getElementById("processingState");

          if (errorState) errorState.classList.add("hidden");
          if (processingState) processingState.classList.remove("hidden");

          // Reset progress
          progress = 0;
          updateProgress(0);
          timerSeconds = 0;
          if (timerElement) {
            timerElement.textContent = `Time elapsed: ${timerSeconds} seconds`;
          }
          verificationAttempts = 0;

          // Restart timer
          if (timerInterval) clearInterval(timerInterval);
          if (timerElement) {
            timerInterval = setInterval(() => {
              timerSeconds++;
              timerElement.textContent = `Time elapsed: ${timerSeconds} seconds`;
            }, 1000);
          }

          // Restart progress
          if (progressInterval) clearInterval(progressInterval);
          if (progressBar) {
            progressInterval = setInterval(() => {
              progress += 1;
              updateProgress(progress);

              if (progress >= 100) {
                clearInterval(progressInterval);
                verifyPayment();
              }
            }, 100);
          } else {
            // If no progress bar, start verification directly
            setTimeout(verifyPayment, 2000);
          }
        }

        function contactSupport() {
          console.log("Contacting support");
          window.location.href = `mailto:support@socialboostpro.com?subject=Payment Issue - Order ${orderId}`;
        }

        // Start verification after short delay
        setTimeout(() => {
          updateProgress(10);
        }, 1000);

        console.log("Payment processing initialized successfully");
      } catch (error) {
        console.error("MAIN SCRIPT ERROR:", error);
        showErrorState("System error occurred. Please contact support.");
      }

      // Global functions for buttons
      window.redirectToSuccess = function () {
        const finalTransactionId =
          document.getElementById("transactionId")?.textContent ||
          `AUTO_${orderId}`;
        window.location.href = `/payment-success?order_id=${orderId}&transaction_id=${finalTransactionId}`;
      };

      window.retryVerification = retryVerification;
      window.contactSupport = contactSupport;
    </script>
  </body>
</html>
