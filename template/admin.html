<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - SocialBoost Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6a11cb;
            --secondary: #2575fc;
            --success: #00c851;
            --warning: #ffbb33;
            --danger: #ff4444;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .admin-header {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 25px;
            text-align: center;
        }
        
        .admin-header h1 {
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
        }
        
        .stat-card h3 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-card.total-revenue .stat-number {
            color: var(--success);
        }
        
        .stat-card.pending-orders .stat-number {
            color: var(--warning);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 25px;
            background: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--box-shadow);
        }
        
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .orders-table {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        .table-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            font-weight: 600;
        }
        
        .table-row {
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        
        .table-row:last-child {
            border-bottom: none;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-verified {
            background: #d4edda;
            color: #155724;
        }
        
        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 12px;
            margin: 2px;
        }
        
        .btn-view {
            background: var(--secondary);
            color: white;
        }
        
        .btn-verify {
            background: var(--success);
            color: white;
        }
        
        .btn-reject {
            background: var(--danger);
            color: white;
        }
        
        .btn-complete {
            background: var(--primary);
            color: white;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .refresh-btn {
            background: var(--secondary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--danger);
        }
        
        .user-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .detail-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-item strong {
            color: var(--primary);
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .detail-item span {
            color: var(--dark);
            font-size: 16px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .table-header, .table-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .table-header {
                display: none;
            }
            
            .user-details-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-cogs"></i> SocialBoost Pro - Admin Panel</h1>
            <p>Manage orders, verify payments, and track revenue</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card total-orders">
                <h3>Total Orders</h3>
                <div class="stat-number" id="totalOrders">0</div>
            </div>
            <div class="stat-card pending-orders">
                <h3>Pending Verification</h3>
                <div class="stat-number" id="pendingOrders">0</div>
            </div>
            <div class="stat-card total-revenue">
                <h3>Total Revenue</h3>
                <div class="stat-number" id="totalRevenue">0 PKR</div>
            </div>
            <div class="stat-card verified-payments">
                <h3>Verified Payments</h3>
                <div class="stat-number" id="verifiedPayments">0</div>
            </div>
        </div>
        
        <button class="refresh-btn" onclick="loadAdminData()">
            <i class="fas fa-sync-alt"></i> Refresh Data
        </button>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('all-orders')">All Orders</button>
            <button class="tab-btn" onclick="switchTab('pending-payments')">Pending Payments</button>
            <button class="tab-btn" onclick="switchTab('verified-payments')">Verified Payments</button>
        </div>
        
        <div class="tab-content active" id="all-orders">
            <div class="orders-table">
                <div class="table-header">
                    <div>Order ID</div>
                    <div>Platform</div>
                    <div>Service</div>
                    <div>Username/URL</div>
                    <div>Amount</div>
                    <div>Status</div>
                    <div>Actions</div>
                </div>
                <div id="allOrdersList"></div>
            </div>
        </div>
        
        <div class="tab-content" id="pending-payments">
            <div class="orders-table">
                <div class="table-header">
                    <div>Order ID</div>
                    <div>Phone</div>
                    <div>Username/URL</div>
                    <div>Amount</div>
                    <div>Payment Method</div>
                    <div>Request Time</div>
                    <div>Actions</div>
                </div>
                <div id="pendingPaymentsList"></div>
            </div>
        </div>
        
        <div class="tab-content" id="verified-payments">
            <div class="orders-table">
                <div class="table-header">
                    <div>Order ID</div>
                    <div>Platform</div>
                    <div>Service</div>
                    <div>Username/URL</div>
                    <div>Amount</div>
                    <div>Transaction ID</div>
                    <div>Verified At</div>
                </div>
                <div id="verifiedPaymentsList"></div>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="userDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2><i class="fas fa-user-circle"></i> User Order Details</h2>
            <div id="userDetailsContent"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://python22.pythonanywhere.com';
        let currentOrders = [];
        
        // Load admin data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminData();
        });
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }
        
        async function loadAdminData() {
            try {
                // Load orders data
                const ordersResponse = await fetch(`${API_BASE}/admin/orders`);
                const ordersData = await ordersResponse.json();
                
                if (ordersData.success) {
                    currentOrders = ordersData.orders;
                    updateStats(ordersData);
                    renderAllOrders(ordersData.orders);
                }
                
                // Load pending payments
                const pendingResponse = await fetch(`${API_BASE}/admin/pending-payments`);
                const pendingData = await pendingResponse.json();
                
                if (pendingData.success) {
                    renderPendingPayments(pendingData.pending_payments);
                }
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                alert('Error loading data. Please check console.');
            }
        }
        
        function updateStats(data) {
            document.getElementById('totalOrders').textContent = data.total_orders;
            document.getElementById('pendingOrders').textContent = data.pending_verifications;
            document.getElementById('totalRevenue').textContent = data.total_revenue.toLocaleString() + ' PKR';
            document.getElementById('verifiedPayments').textContent = data.verified_payments;
        }
        
        function renderAllOrders(orders) {
            const container = document.getElementById('allOrdersList');
            container.innerHTML = '';
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="table-row" style="text-align: center; grid-template-columns: 1fr;">No orders found</div>';
                return;
            }
            
            orders.forEach(order => {
                const row = document.createElement('div');
                row.className = 'table-row';
                
                // Get username/URL for display
                const displayUsername = order.channel_url || order.username;
                const shortUsername = displayUsername.length > 20 ? 
                    displayUsername.substring(0, 20) + '...' : displayUsername;
                
                row.innerHTML = `
                    <div>${order.order_id}</div>
                    <div>${order.platform}</div>
                    <div>${order.service_type} (${order.quantity})</div>
                    <div title="${displayUsername}">${shortUsername}</div>
                    <div>${order.total_amount.toLocaleString()} PKR</div>
                    <div>
                        <span class="status-badge status-${order.payment_status}">
                            ${order.payment_status}
                        </span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <button class="action-btn btn-view" onclick="viewUserDetails('${order.order_id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        ${order.payment_status === 'pending' ? 
                            `<button class="action-btn btn-verify" onclick="verifyPayment('${order.order_id}')">
                                <i class="fas fa-check"></i> Verify
                            </button>
                            <button class="action-btn btn-reject" onclick="rejectPayment('${order.order_id}')">
                                <i class="fas fa-times"></i> Reject
                            </button>` :
                            `<button class="action-btn btn-complete" onclick="completeOrder('${order.order_id}')">
                                <i class="fas fa-flag"></i> Complete
                            </button>`
                        }
                        <button class="action-btn btn-delete" onclick="deleteOrder('${order.order_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                
                container.appendChild(row);
            });
        }
        
        function renderPendingPayments(payments) {
            const container = document.getElementById('pendingPaymentsList');
            container.innerHTML = '';
            
            if (payments.length === 0) {
                container.innerHTML = '<div class="table-row" style="text-align: center; grid-template-columns: 1fr;">No pending payments</div>';
                return;
            }
            
            payments.forEach(payment => {
                const row = document.createElement('div');
                row.className = 'table-row';
                
                row.innerHTML = `
                    <div>${payment.order_id}</div>
                    <div>${payment.phone_number}</div>
                    <div>${payment.username || 'N/A'}</div>
                    <div>${payment.amount} PKR</div>
                    <div>${payment.payment_method}</div>
                    <div>${new Date(payment.request_time).toLocaleString()}</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <button class="action-btn btn-view" onclick="viewUserDetails('${payment.order_id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="action-btn btn-verify" onclick="verifyPayment('${payment.order_id}')">
                            <i class="fas fa-check"></i> Verify
                        </button>
                        <button class="action-btn btn-reject" onclick="rejectPayment('${payment.order_id}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteOrder('${payment.order_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                
                container.appendChild(row);
            });
        }
        
        function renderVerifiedPayments(payments) {
            const container = document.getElementById('verifiedPaymentsList');
            container.innerHTML = '';
            
            if (payments.length === 0) {
                container.innerHTML = '<div class="table-row" style="text-align: center; grid-template-columns: 1fr;">No verified payments</div>';
                return;
            }
            
            payments.forEach(payment => {
                const row = document.createElement('div');
                row.className = 'table-row';
                
                row.innerHTML = `
                    <div>${payment.order_id}</div>
                    <div>${payment.platform}</div>
                    <div>${payment.service_type} (${payment.quantity})</div>
                    <div>${payment.username}</div>
                    <div>${payment.total_amount} PKR</div>
                    <div>${payment.transaction_id || 'N/A'}</div>
                    <div>${new Date(payment.verified_at).toLocaleString()}</div>
                `;
                
                container.appendChild(row);
            });
        }
        
        // VIEW USER DETAILS FUNCTION
        function viewUserDetails(orderId) {
            const order = currentOrders.find(o => o.order_id === orderId);
            if (!order) {
                alert('Order not found!');
                return;
            }
            
            const modal = document.getElementById('userDetailsModal');
            const content = document.getElementById('userDetailsContent');
            
            content.innerHTML = `
                <div class="user-details-grid">
                    <div class="detail-item">
                        <strong>Order ID:</strong>
                        <span>${order.order_id}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Platform:</strong>
                        <span>${order.platform}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Service Type:</strong>
                        <span>${order.service_type}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Quantity:</strong>
                        <span>${order.quantity}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Username:</strong>
                        <span>${order.username}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Channel URL:</strong>
                        <span>${order.channel_url || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Email:</strong>
                        <span>${order.email}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Phone:</strong>
                        <span>${order.phone}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Total Amount:</strong>
                        <span>${order.total_amount.toLocaleString()} PKR</span>
                    </div>
                    <div class="detail-item">
                        <strong>Payment Method:</strong>
                        <span>${order.payment_method}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Status:</strong>
                        <span class="status-badge status-${order.payment_status}">${order.payment_status}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Created At:</strong>
                        <span>${new Date(order.created_at).toLocaleString()}</span>
                    </div>
                    ${order.current_subscribers ? `
                    <div class="detail-item">
                        <strong>Current Subscribers:</strong>
                        <span>${order.current_subscribers}</span>
                    </div>
                    ` : ''}
                    ${order.channel_category ? `
                    <div class="detail-item">
                        <strong>Channel Category:</strong>
                        <span>${order.channel_category}</span>
                    </div>
                    ` : ''}
                    ${order.special_instructions ? `
                    <div class="detail-item full-width">
                        <strong>Special Instructions:</strong>
                        <span>${order.special_instructions}</span>
                    </div>
                    ` : ''}
                    <div class="detail-item">
                        <strong>User IP:</strong>
                        <span>${order.user_ip || 'N/A'}</span>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="action-btn btn-verify" onclick="verifyPayment('${order.order_id}'); closeModal();">
                        <i class="fas fa-check"></i> Verify Payment
                    </button>
                    <button class="action-btn btn-delete" onclick="deleteOrder('${order.order_id}'); closeModal();">
                        <i class="fas fa-trash"></i> Delete Order
                    </button>
                    <button class="action-btn" onclick="closeModal()" style="background: #6c757d; color: white;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('userDetailsModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('userDetailsModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        async function verifyPayment(orderId) {
            const transactionId = prompt('Enter Transaction ID:');
            if (!transactionId) return;
            
            const adminSecret = prompt('Enter Admin Secret:');
            if (!adminSecret) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/verify-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        transaction_id: transactionId,
                        admin_secret: adminSecret
                    })
                });
                
                const result = await response.json();
                alert(result.message);
                
                if (result.success) {
                    loadAdminData();
                }
            } catch (error) {
                alert('Error verifying payment: ' + error.message);
            }
        }
        
        async function rejectPayment(orderId) {
            const reason = prompt('Enter rejection reason:', 'Payment not received');
            if (reason === null) return;
            
            const adminSecret = prompt('Enter Admin Secret:');
            if (!adminSecret) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/reject-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        admin_secret: adminSecret,
                        reason: reason
                    })
                });
                
                const result = await response.json();
                alert(result.message);
                
                if (result.success) {
                    loadAdminData();
                }
            } catch (error) {
                alert('Error rejecting payment: ' + error.message);
            }
        }
        
        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order? This action cannot be undone!')) {
                return;
            }
            
            const adminSecret = prompt('Enter Admin Secret to confirm deletion:');
            if (!adminSecret) return;
            
            try {
                // You'll need to add a delete endpoint in your Flask backend
                const response = await fetch(`${API_BASE}/admin/delete-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        admin_secret: adminSecret
                    })
                });
                
                const result = await response.json();
                alert(result.message);
                
                if (result.success) {
                    loadAdminData();
                }
            } catch (error) {
                alert('Error deleting order: ' + error.message);
            }
        }
        
        function completeOrder(orderId) {
            alert('Order completion functionality to be implemented for: ' + orderId);
        }
        
        // Auto-refresh every 30 seconds
        setInterval(loadAdminData, 30000);
    </script>
</body>
</html>
